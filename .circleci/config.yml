version: 2
jobs:
  build:
    working_directory: ~/App
    docker:
      - image: jacekmarchwicki/android:java7-8
    branches:
      ignore:
        - master
    steps:
      - restore_cache:
          key: projectname-{{ .Branch }}
      - run:
          name: Install Docker client
          command: |
              set -x
              VER="17.03.0-ce"
              curl -L -o /tmp/docker-$VER.tgz https://get.docker.com/builds/Linux/x86_64/docker-$VER.tgz
              tar -xz -C /tmp -f /tmp/docker-$VER.tgz
              mv /tmp/docker/* /usr/bin
      - run:
          name: Inside docker
          command: docker run --tty --interactive --volume=$(pwd):/opt/workspace --workdir=/opt/workspace --rm jacekmarchwicki/android:java7-8 /bin/sh
      - run:
          name: Setup
          command: |
              export GRADLE_USER_HOME="$(pwd)/.gradle"
              export ANDROID_HOME="$(pwd)/.android"
              mkdir -p "${ANDROID_HOME}/licenses"
              echo -e "\n8933bad161af4178b1185d1a37fbf41ea5269c55" > "${ANDROID_HOME}/licenses/android-sdk-license"
              echo -e "\n84831b9409646a918e30573bab4c9c91346d8abd" > "${ANDROID_HOME}/licenses/android-sdk-preview-license"
              echo -e "\nd975f751698a77b662f1254ddbeed3901e976f5a" > "${ANDROID_HOME}/licenses/intel-android-extra-license"
      - checkout
      - run:
          name: Building
          command: ./gradlew --parallel --stacktrace --no-daemon build
      - run:
          name: Testing
          command: ./gradlew test
      - save_cache:
          key: projectname-{{ .Branch }}
          paths:
            - "~/.cache"
      - store_test_results:
          path: app/build/test-results/testDebugUnitTest
      - store_test_results:
          path: app/build/test-results/testReleaseUnitTest